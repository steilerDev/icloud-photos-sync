import {View} from "./view.js";

// License free images from sites like uxwing.com
export const checkSymbol = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" width="122.88px" height="122.88px" viewBox="0 0 122.88 122.88" enable-background="new 0 0 122.88 122.88" xml:space="preserve"><g><path fill="#6BBE66" d="M34.388,67.984c-0.286-0.308-0.542-0.638-0.762-0.981c-0.221-0.345-0.414-0.714-0.573-1.097 c-0.531-1.265-0.675-2.631-0.451-3.934c0.224-1.294,0.812-2.531,1.744-3.548l0.34-0.35c2.293-2.185,5.771-2.592,8.499-0.951 c0.39,0.233,0.762,0.51,1.109,0.827l0.034,0.031c1.931,1.852,5.198,4.881,7.343,6.79l1.841,1.651l22.532-23.635 c0.317-0.327,0.666-0.62,1.035-0.876c0.378-0.261,0.775-0.482,1.185-0.661c0.414-0.181,0.852-0.323,1.3-0.421 c0.447-0.099,0.903-0.155,1.356-0.165h0.026c0.451-0.005,0.893,0.027,1.341,0.103c0.437,0.074,0.876,0.193,1.333,0.369 c0.421,0.161,0.825,0.363,1.207,0.604c0.365,0.231,0.721,0.506,1.056,0.822l0.162,0.147c0.316,0.313,0.601,0.653,0.85,1.014 c0.256,0.369,0.475,0.766,0.652,1.178c0.183,0.414,0.325,0.852,0.424,1.299c0.1,0.439,0.154,0.895,0.165,1.36v0.23 c-0.004,0.399-0.042,0.804-0.114,1.204c-0.079,0.435-0.198,0.863-0.356,1.271c-0.16,0.418-0.365,0.825-0.607,1.21 c-0.238,0.377-0.518,0.739-0.832,1.07l-27.219,28.56c-0.32,0.342-0.663,0.642-1.022,0.898c-0.369,0.264-0.767,0.491-1.183,0.681 c-0.417,0.188-0.851,0.337-1.288,0.44c-0.435,0.104-0.889,0.166-1.35,0.187l-0.125,0.003c-0.423,0.009-0.84-0.016-1.241-0.078 l-0.102-0.02c-0.415-0.07-0.819-0.174-1.205-0.31c-0.421-0.15-0.833-0.343-1.226-0.575l-0.063-0.04 c-0.371-0.224-0.717-0.477-1.032-0.754l-0.063-0.06c-1.58-1.466-3.297-2.958-5.033-4.466c-3.007-2.613-7.178-6.382-9.678-9.02 L34.388,67.984L34.388,67.984z M61.44,0c16.96,0,32.328,6.883,43.453,17.987c11.104,11.125,17.986,26.493,17.986,43.453 c0,16.961-6.883,32.329-17.986,43.454C93.769,115.998,78.4,122.88,61.44,122.88c-16.961,0-32.329-6.882-43.454-17.986 C6.882,93.769,0,78.4,0,61.439C0,44.48,6.882,29.112,17.986,17.987C29.112,6.883,44.479,0,61.44,0L61.44,0z M96.899,25.981 C87.826,16.907,75.29,11.296,61.44,11.296c-13.851,0-26.387,5.611-35.46,14.685c-9.073,9.073-14.684,21.609-14.684,35.458 c0,13.851,5.611,26.387,14.684,35.46s21.609,14.685,35.46,14.685c13.85,0,26.386-5.611,35.459-14.685s14.684-21.609,14.684-35.46 C111.583,47.59,105.973,35.054,96.899,25.981L96.899,25.981z"/></g></svg>`;

export const syncSymbol = `<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 112.62 120.72"><path fill="#4281ff" d="M11.64,100.12l-.4-.47-1.06,8.63a5.08,5.08,0,0,1-1.92,3.41A5.11,5.11,0,0,1,0,107L2.79,84.65v-.07a3.28,3.28,0,0,1,.08-.41h0A5.09,5.09,0,0,1,9,80.39q11.22,2.53,22.42,5.15a5,5,0,0,1,3.17,2.25,5.14,5.14,0,0,1,.64,3.84v0a5,5,0,0,1-2.25,3.16,5.08,5.08,0,0,1-3.83.65c-3.31-.75-6.62-1.52-9.92-2.28a40.71,40.71,0,0,0,2.84,3,50.09,50.09,0,0,0,26.23,13.49,48.67,48.67,0,0,0,14.71.34A47.35,47.35,0,0,0,77,106h0q2.52-1.19,4.83-2.54c1.56-.93,3.07-1.92,4.51-3a50.8,50.8,0,0,0,8.56-7.88,48.92,48.92,0,0,0,6.39-9.45l.56-1.1,10,2.69-.8,1.66a58.64,58.64,0,0,1-7.9,12.24,61.28,61.28,0,0,1-10.81,10.1c-1.68,1.23-3.46,2.4-5.32,3.5s-3.73,2.07-5.74,3a58,58,0,0,1-17,5,58.56,58.56,0,0,1-17.79-.39,60.21,60.21,0,0,1-31.58-16.26c-1.2-1.16-2.26-2.31-3.24-3.45ZM101,20.6l.4.47,1-8.63a5.11,5.11,0,1,1,10.14,1.26l-2.74,22.37,0,.07c0,.13,0,.27-.07.41h0a5.09,5.09,0,0,1-6.08,3.78c-7.47-1.69-15-3.4-22.42-5.15a5,5,0,0,1-3.16-2.25,5.1,5.1,0,0,1-.65-3.84v0a5,5,0,0,1,2.25-3.16,5.1,5.1,0,0,1,3.84-.65c3.31.75,6.61,1.52,9.92,2.28-.84-1-1.77-2-2.84-3.05a50.09,50.09,0,0,0-12.13-8.73A49.49,49.49,0,0,0,64.37,11a48.6,48.6,0,0,0-14.7-.34,47.26,47.26,0,0,0-14,4.1h0q-2.53,1.18-4.83,2.54c-1.57.93-3.07,1.92-4.52,3a50.34,50.34,0,0,0-8.55,7.88,48,48,0,0,0-6.39,9.45l-.57,1.1L.76,36l.8-1.66A58.9,58.9,0,0,1,9.46,22.1,61.63,61.63,0,0,1,20.27,12q2.54-1.85,5.32-3.5c1.81-1.06,3.73-2.07,5.74-3a58,58,0,0,1,17-5A58.56,58.56,0,0,1,66.16.89a59.77,59.77,0,0,1,17,5.74A60.4,60.4,0,0,1,97.75,17.15c1.19,1.16,2.26,2.31,3.24,3.45Z"/></svg>`;

export const failedSymbol = `<?xml version="1.0" encoding="utf-8"?><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 122.88 122.88" style="enable-background:new 0 0 122.88 122.88" xml:space="preserve"><style type="text/css">.st0{fill-rule:evenodd;clip-rule:evenodd;}</style><g><path fill="#f00" class="st0" d="M1.63,97.99l36.55-36.55L1.63,24.89c-2.17-2.17-2.17-5.73,0-7.9L16.99,1.63c2.17-2.17,5.73-2.17,7.9,0 l36.55,36.55L97.99,1.63c2.17-2.17,5.73-2.17,7.9,0l15.36,15.36c2.17,2.17,2.17,5.73,0,7.9L84.7,61.44l36.55,36.55 c2.17,2.17,2.17,5.73,0,7.9l-15.36,15.36c-2.17,2.17-5.73,2.17-7.9,0L61.44,84.7l-36.55,36.55c-2.17,2.17-5.73,2.17-7.9,0 L1.63,105.89C-0.54,103.72-0.54,100.16,1.63,97.99L1.63,97.99z"/></g></svg>`;

export const authenticatingSymbol = (color = `#4281ff`) => `
<?xml version="1.0" encoding="utf-8"?><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="122.88px" height="121.203px" viewBox="0 0 122.88 121.203" enable-background="new 0 0 122.88 121.203" xml:space="preserve"><g><path fill="${color}" fill-rule="evenodd" clip-rule="evenodd" d="M82.299,60.756l40.581,41.111v19.336h-19.2v-14.535H87.771v-15.91H72.546 L68.145,76.42c-7.01,4.674-15.514,7.412-24.678,7.412C19.466,83.832,0,65.063,0,41.916S19.466,0,43.467,0 c24.002,0,43.465,18.77,43.465,41.916C86.932,48.692,85.261,55.091,82.299,60.756L82.299,60.756z M37.22,28.487 c4.283,0,7.76,3.474,7.76,7.76c0,4.286-3.477,7.76-7.76,7.76c-4.286,0-7.76-3.474-7.76-7.76 C29.459,31.961,32.934,28.487,37.22,28.487L37.22,28.487z"/></g></svg>`;

export class StateView extends View {
    protected override get content(): string {
        return `
            <style>
                .state-symbol {
                    margin: 1rem;
                    width: 35%;
                    display: none;
                    text-align: center;
                    font-size: 7rem;
                    color: orange;
                }
                .state-symbol svg {
                    width: 100%;
                    height: 100%;
                }
                #syncing-symbol {
                    animation: rotate 10s linear infinite;
                }
                @keyframes rotate {
                    0% {
                        transform: rotate(0deg);
                    }
                    100% {
                        transform: rotate(360deg);
                    }
                }
                #state-text {
                    text-align: center;
                    width: 75%;
                    margin: auto;
                    margin-top: 1rem;
                    margin-bottom: 1rem;
                }
                #enter-mfa-section {
                    text-align: center;
                    width: 90%;
                    margin: auto;
                    margin-bottom: 1rem;
                    background-color: #d8d8d8;
                    padding: 1rem;
                    border-radius: 0.5rem;
                    box-sizing: border-box;
                }
                #enter-mfa-section button {
                    width: 100%;
                }
            </style>
            <div id="enter-mfa-section" style="display: none;">
                Sync is waiting for Multifactor Authentication (MFA). Please enter your MFA code.<br/>
                <button onclick="navigate('submit-mfa')">Enter MFA Code</button>
            </div>
            <div class="state-symbol" id="unknown-symbol" style="display: block">?</div>
            <div class="state-symbol" id="ok-symbol">${checkSymbol}</div>
            <div class="state-symbol" id="syncing-symbol">${syncSymbol}</div>
            <div class="state-symbol" id="error-symbol">${failedSymbol}</div>
            <div class="state-symbol" id="authenticating-symbol">${authenticatingSymbol()}</div>
            <div class="state-symbol" id="reauthSuccess-symbol">${authenticatingSymbol(`#6BBE66`)}</div>
            <div class="state-symbol" id="reauthError-symbol">${authenticatingSymbol(`#F00`)}</div>
            <p id="state-text">...</p>
            <p class="hidden-when-busy"  id="next-sync-text" style="display: none">Next Sync scheduled at<br/><span id="next-sync-time">...</span></p>
            <button id="sync-button" class="hidden-when-busy" onclick="sync()">Sync Now</button>
            <button id="reauth-button" class="hidden-when-busy" onclick="reauthenticate()">Renew Authentication</button>
            <script type="text/javascript">
                async function sync() {
                    const response = await fetch("sync", { method: "POST" });
                    if (!response.ok) {
                        alert("Sync failed: " + response.statusText);
                        return;
                    }
                }
                async function reauthenticate() {
                    const response = await fetch("reauthenticate", { method: "POST" });
                    if (!response.ok) {
                        alert("Reauthentication failed: " + response.statusText);
                        return;
                    }
                    navigate("submit-mfa");
                }

                function formatDateOrUndefined(date) {
                    if (!date) {
                        return "Unknown ";
                    }
                    return new Date(date).toLocaleString()
                }

                const textForState = {
                    unknown: "Unknown",
                    syncing: "Syncing...",
                    ok: "Last Sync Successful at<br/>{stateTimestamp}",
                    error: "Last Sync Failed at<br/>{stateTimestamp}<br/><br/><span style=\\"color: red; font-weight: bold\\">{errorMessage}</span>",
                    authenticating: "Authenticating...",
                    reauthSuccess: "Reauthentication Successful at<br/>{stateTimestamp}",
                    reauthError: "Reauthentication Failed at<br/>{stateTimestamp}<br/><br/><span style=\\"color: red; font-weight: bold\\">{errorMessage}</span>",
                };

                const busyStates = ["syncing", "authenticating"];

                let connectionLost = false;

                async function updateState() {
                    try {
                        let stateJson;
                        try{
                            const state = await fetch("state", { headers: {
                                "Accept": "application/json",
                                "Content-Type": "application/json"
                            } });
                            stateJson = await state.json();
                        } catch (error) {
                            connectionLost = true;
                            throw error;
                        }

                        // if we temporarily lost connection, reload the page
                        // as the server might have restarted on a new version
                        // that has an incompatible API
                        if(connectionLost) {
                            window.location.reload();
                            return;
                        }

                        document.querySelectorAll(".state-symbol").forEach((el) => {
                            el.style.display = "none";
                        });
                        document.querySelector("#" + stateJson.state + "-symbol").style.display = "block";

                        document.querySelector("#state-text").innerHTML = 
                            textForState[stateJson.state]
                                .replace("{stateTimestamp}", formatDateOrUndefined(stateJson.stateTimestamp))
                                .replace("{errorMessage}", stateJson.errorMessage);

                        if(stateJson.nextSyncTimestamp) {
                            document.querySelector("#next-sync-text").style.display = "block";
                            document.querySelector("#next-sync-time").innerHTML = formatDateOrUndefined(stateJson.nextSyncTimestamp);
                        }

                        if(busyStates.includes(stateJson.state)) {
                            document.querySelectorAll(".hidden-when-busy").forEach((el) => {
                                el.style.display = "none";
                            });
                        } else {
                            document.querySelectorAll(".hidden-when-busy").forEach((el) => {
                                el.style.display = "block";
                            });
                        }

                        document.getElementById("enter-mfa-section").style.display = stateJson.waitingForMfa ? "block" : "none";
                    } catch (error) {
                        console.error("Error fetching state:", error);
                        document.querySelectorAll(".state-symbol").forEach((el) => {
                            el.style.display = "none";
                        });
                        document.querySelector("#error-symbol").style.display = "block";
                        document.querySelector("#state-text").innerHTML = "Error updating state";
                    }
                }
                setTimeout(() => updateState(), 0);
                setInterval(updateState, 1000);
            </script>
        `;
    }
}
